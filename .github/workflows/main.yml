name: Build Kodi GBM for Ubuntu Server 24.04 x86_64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04  # 使用 Ubuntu 24.04 运行器

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git cmake build-essential autoconf autogen automake libtool libass-dev libdrm-dev libegl1-mesa-dev libgbm-dev libgles2-mesa-dev libwayland-dev libxkbcommon-dev libpulse-dev libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libswresample-dev libdvdnav-dev libdvdread-dev libbluray-dev libfreetype6-dev libfribidi-dev libharfbuzz-dev libfontconfig-dev libxml2-dev libxslt1-dev libmicrohttpd-dev libudfread-dev libmpeg2-4-dev libvdpau-dev libva-dev libvorbis-dev libogg-dev libflac-dev libcdio-paranoia-dev libiso9660-dev libplist-dev libtinyxml2-dev python3-dev nasm yasm zlib1g-dev libcurl4-gnutls-dev libtag1-dev libcrossguid-dev liblzo2-dev libbz2-dev libdcadec-dev libsamplerate0-dev libwavpack-dev libxml2-utils python3-pip
        # 额外 GBM/DRM 依赖
        sudo apt-get install -y libinput-dev libmtdev-dev libudev-dev libxrandr-dev libxinerama-dev libxcursor-dev libxext-dev libxi-dev libxfixes-dev

    - name: Get latest Kodi tag
      id: kodi_tag
      run: |
        LATEST_TAG=$(git ls-remote --tags https://github.com/xbmc/xbmc.git | grep -v '{}' | awk '{print $2}' | sort -V | tail -n1 | sed 's/refs\/tags\///')
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest Kodi tag: $LATEST_TAG"

    - name: Clone Kodi source
      run: |
        git clone --branch ${{ steps.kodi_tag.outputs.tag }} --depth 1 https://github.com/xbmc/xbmc.git kodi-source
        cd kodi-source
        git submodule update --init --recursive

    - name: Configure and build Kodi with GBM
      run: |
        chmod +x build.sh
        ./build.sh ${{ steps.kodi_tag.outputs.tag }}

    - name: Package release
      run: |
        tar -czf kodi-${{ steps.kodi_tag.outputs.tag }}-gbm-ubuntu24.04-x86_64.tar.gz -C build/kodi-gbm/ .
        ls -la kodi-*.tar.gz

    - name: Create Release
      if: github.ref == 'refs/heads/main'  # 只在 main 分支 push 时创建 release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.kodi_tag.outputs.tag }}
        name: Kodi ${{ steps.kodi_tag.outputs.tag }} GBM Ubuntu 24.04 x86_64
        body: |
          Auto-built Kodi GBM version for Ubuntu Server 24.04 (x86_64, Intel i5-1235U compatible).
          - Platform: x86_64
          - Backend: GBM (no Xorg)
          - Archive: kodi-${{ steps.kodi_tag.outputs.tag }}-gbm-ubuntu24.04-x86_64.tar.gz
        files: kodi-*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
