name: Build Kodi GBM for Ubuntu 24.04

on:
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      
      - name: Checkout this repository
        uses: actions/checkout@v4

      # 1. 缓存 Kodi 源码
      - name: Cache Kodi source
        id: cache-kodi-src
        uses: actions/cache@v4
        with:
          path: kodi-src
          key: kodi-src-${{ hashFiles('**/.git/HEAD') }}
          restore-keys: |
            kodi-src-

      # 2. 仅在缓存未命中时才 clone
      - name: Clone Kodi source
        if: steps.cache-kodi-src.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/xbmc/xbmc.git kodi-src

      - name: Install dependencies
        run: |
          sudo add-apt-repository -s ppa:team-xbmc/xbmc-nightly
          sudo apt update && sudo apt upgrade -y
          sudo apt build-dep kodi
            
      # 4. 缓存 ccache
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.9
        with:
          key: kodi-ccache-${{ runner.os }}-${{ hashFiles('kodi-src/.git/HEAD') }}
          max-size: 2G

      # 5. 构建libdisplay-info
      - name: Build libdisplay-info
        run: |
          git clone https://gitlab.freedesktop.org/emersion/libdisplay-info.git
          cd libdisplay-info
          meson setup build
          meson compile -C build
          sudo meson install -C build

      - name: Configure Kodi GBM
        run: |
          cd kodi-src
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_PVR=ON \
            -DWITH_PVR_ADDONS=ON \
            -DENABLE_INTERNAL_PVR=ON \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DCCACHE_FOUND=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCPACK_GENERATOR=DEB \
            -DCPACK_PACKAGE_NAME=kodi \
            -DCPACK_PACKAGE_CONTACT="zxm <zxm1500@gmail.com>" \
            -DCPACK_PACKAGE_DESCRIPTION_SUMMARY="Kodi Media Center" \
            -DCPACK_DEBIAN_PACKAGE_MAINTAINER="zxm"
      
      - name: Build Kodi
        run: |
          cd kodi-src/build
          make -j$(nproc)

      - name: Package Kodi
        run: |
          cd kodi-src/build
          cpack -G DEB
          mkdir -p ../../artifacts
          echo "Listing generated packages:"
          ls -la packages/
          cp packages/*.deb ../../artifacts/ || true
          echo "Artifacts copied:"
          ls -la ../../artifacts/

      - name: Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm-ubuntu24.04
          path: artifacts/

      # - name: Upload to GitHub Releases
      #   uses: softprops/action-gh-release@v2
      #   if: github.event_name == 'workflow_dispatch'
      #   with:
      #     files: artifacts/*.deb
      #     tag_name: "build-${{ github.run_id }}"
      #     name: "Kodi GBM Build #${{ github.run_id }}"
      #     draft: false
      #     prerelease: true
