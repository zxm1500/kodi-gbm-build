name: Build Kodi GBM for Ubuntu 24.04

on:
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake autopoint gettext autotools-dev cmake curl default-jre gawk gcc g++ cpp \
            flatbuffers-compiler libflatbuffers-dev \
            gperf libasound2-dev libass-dev libavahi-client-dev libavahi-common-dev libbluetooth-dev \
            libbluray-dev libbz2-dev libcdio-dev libcec-dev libp8-platform-dev libcrossguid-dev \
            libcurl4-openssl-dev libcwiid-dev libdbus-1-dev libegl1-mesa-dev libenca-dev libexiv2-dev \
            libflac-dev libfontconfig-dev libfreetype6-dev libfribidi-dev libfstrcmp-dev libgcrypt-dev \
            libgif-dev libgl1-mesa-dev libglew-dev libglu1-mesa-dev libgnutls28-dev libgpg-error-dev \
            libgtest-dev libiso9660-dev libjpeg-dev liblcms2-dev liblirc-dev libltdl-dev liblzo2-dev \
            libmicrohttpd-dev libmysqlclient-dev libnfs-dev libogg-dev libpcre2-dev libplist-dev \
            libpng-dev libpulse-dev libshairplay-dev libsmbclient-dev libspdlog-dev libsqlite3-dev \
            libssl-dev libtag1-dev libtiff-dev libtinyxml-dev libtinyxml2-dev libtool libudev-dev \
            libunistring-dev libva-dev libvdpau-dev libvorbis-dev libxkbcommon-dev libxmu-dev \
            libxrandr-dev libxslt-dev libxt-dev wayland-protocols meson nasm ninja-build python3-dev \
            python3-pil swig unzip uuid-dev zip zlib1g-dev nlohmann-json3-dev libgbm-dev ccache

      - name: Clone Kodi source
        run: |
          git clone --depth=1 https://github.com/xbmc/xbmc.git kodi-src

      - name: Build libdisplay-info
        run: |
          git clone https://gitlab.freedesktop.org/emersion/libdisplay-info.git
          cd libdisplay-info
          meson setup build
          meson compile -C build
          sudo meson install -C build

      - name: Configure Kodi GBM
        run: |
          cd kodi-src
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DENABLE_CCACHE=ON
      
      - name: Build Kodi
        run: |
          cd kodi-src/build
          make -j$(nproc)

      - name: Package Kodi
        run: |
          cd kodi-src/build
          cpack -G DEB
          mkdir -p ../../artifacts
          cp *.deb ../../artifacts/ || true

      - name: Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm-ubuntu24.04
          path: artifacts/
