name: Build Kodi GBM for Ubuntu 24.04

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      PKG_CONFIG_PATH: /home/runner/.local/lib/pkgconfig
      LD_LIBRARY_PATH: /home/runner/.local/lib

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      # 获取目标分支/标签的最新 commit SHA，用作缓存 key
      - name: Get Kodi remote commit SHA
        id: kodi_sha
        run: |
          set -euo pipefail
          REPO="https://github.com/xbmc/xbmc.git"
          BRANCH="21.3-Omega"

          echo "=== git ls-remote (all refs) ==="
          git ls-remote "$REPO" || true

          echo "=== Looking for branch refs/heads/$BRANCH ==="
          SHA=$(git ls-remote --heads "$REPO" "refs/heads/$BRANCH" | cut -f1)
          if [ -n "$SHA" ]; then
            echo "Found branch SHA: $SHA"
          else
            echo "Branch not found, trying tags with name $BRANCH ..."
            SHA=$(git ls-remote --tags "$REPO" "refs/tags/$BRANCH" | cut -f1)
            if [ -n "$SHA" ]; then
              echo "Found tag SHA: $SHA"
            fi
          fi

          if [ -z "$SHA" ]; then
            echo "Branch/tag '$BRANCH' not found in $REPO."
            echo "Listing a few heads and tags for debugging:"
            git ls-remote --heads "$REPO" | sed -n '1,200p' || true
            git ls-remote --tags "$REPO" | sed -n '1,200p' || true

            # fallback: use a non-empty but unique key so the job continues (cache will not hit)
            SHA="no-remote-sha-$(date +%s)"
            echo "Using fallback SHA/key: $SHA"
          fi

          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      # ----------------- 源码缓存（基于远程 commit SHA） -----------------
      - name: Cache Kodi source
        id: cache-kodi-src
        uses: actions/cache@v4
        with:
          path: kodi-src
          key: kodi-src-21.3-Omega-v3-${{ steps.kodi_sha.outputs.sha }}
          restore-keys: |
            kodi-src-21.3-Omega-v3-

      - name: Clone Kodi source (only when cache miss)
        if: steps.cache-kodi-src.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=21.3-Omega https://github.com/xbmc/xbmc.git kodi-src

      # 如果 cache 命中但目录不存在（极端情况），仍然确保目录存在
      - name: Ensure kodi-src exists
        if: steps.cache-kodi-src.outputs.cache-hit == 'true'
        run: |
          if [ ! -d kodi-src ]; then
            echo "Cache reported hit but kodi-src missing; cloning as fallback"
            git clone --depth=1 --branch=21.3-Omega https://github.com/xbmc/xbmc.git kodi-src
          fi

      # ----------------- 系统依赖（完整且补充必要打包/egl包） -----------------
      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y \
            autoconf automake autopoint bison flex gettext \
            cmake curl gcc g++ git pkg-config yasm nasm \
            meson ninja-build swig unzip ccache \
            build-essential libtool fakeroot dpkg-dev \
            libasound2-dev libass-dev libbluray-dev libbz2-dev \
            libcdio-dev libcec-dev libcurl4-openssl-dev \
            libdbus-1-dev libexiv2-dev libflac-dev libfontconfig-dev \
            libfreetype6-dev libfribidi-dev libgcrypt20-dev \
            libgif-dev libgl1-mesa-dev libglu1-mesa-dev \
            libegl1-mesa-dev libgles2-mesa-dev \
            libgnutls28-dev libgpg-error-dev libiso9660-dev \
            libjpeg-dev liblcms2-dev liblirc-dev liblzo2-dev \
            libmicrohttpd-dev libnfs-dev libogg-dev libpcre2-dev \
            libplist-dev libpng-dev libpulse-dev libshairplay-dev \
            libsmbclient-dev libspdlog-dev libsqlite3-dev libssl-dev \
            libtag1-dev libtiff5-dev libtinyxml2-dev libudev-dev \
            libva-dev libvdpau-dev libvorbis-dev libxml2-dev libxslt1-dev \
            libxkbcommon-dev libxrandr-dev zlib1g-dev \
            libwayland-dev libgbm-dev libdrm-dev libinput-dev \
            libdisplay-info-dev liburiparser-dev rapidjson-dev \
            nlohmann-json3-dev flatbuffers-compiler libflatbuffers-dev libpugixml-dev \
            python3-dev libfstrcmp-dev libpcre3 libpcre3-dev libtinyxml-dev libgtest-dev libunistring-dev

      # ----------------- ccache（基于同一 commit SHA） -----------------
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: kodi-ccache-ubuntu24-v3-${{ steps.kodi_sha.outputs.sha }}
          max-size: 2G

      # ----------------- 创建 artifacts 目录 -----------------
      - name: Prepare artifacts dir
        run: mkdir -p ~/artifacts

      # ----------------- 编译 Kodi GBM -----------------
      - name: Build Kodi GBM
        run: |
          set -euo pipefail
          cd kodi-src
          rm -rf build && mkdir build && cd build

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_OPENGL=OFF \
            -DENABLE_OPENGLES=ON \
            -DENABLE_X11=OFF \
            -DENABLE_WAYLAND=OFF \
            -DENABLE_VAAPI=OFF \
            -DENABLE_VDPAU=OFF \
            -DENABLE_PVR=ON \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCPACK_GENERATOR=DEB

          make -j$(nproc)

            # 安装到临时目录
          mkdir -p /tmp/kodi-install
          make DESTDIR=/tmp/kodi-install install

          # 检查安装的文件
          echo "=== 检查安装的文件 ==="
          find /tmp/kodi-install -type f | head -20

          # 创建 DEB 包目录结构
          mkdir -p /tmp/kodi-pkg/DEBIAN
          
          # 创建 control 文件（修复格式）
          cat > /tmp/kodi-pkg/DEBIAN/control << 'EOF'
          Package: kodi-gbm
          Version: 21.3-1
          Section: video
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.34), libstdc++6 (>= 12), libgcc1 (>= 12), zlib1g (>= 1:1.2.11)
          Maintainer: Kodi Builder <builder@kodi.org>
          Description: Kodi Media Center with GBM support
           Kodi is an award-winning free and open source software media center.
           This version is built with GBM platform support for Ubuntu 24.04.
          Homepage: https://kodi.tv
          EOF

          # 复制文件到包目录
          mkdir -p /tmp/kodi-pkg
          cp -r /tmp/kodi-install/* /tmp/kodi-pkg/

          # 修复文件权限
          find /tmp/kodi-pkg -type d -exec chmod 755 {} \;
          find /tmp/kodi-pkg -type f -exec chmod 644 {} \;
          find /tmp/kodi-pkg/usr -name "*.so*" -exec chmod 755 {} \; 2>/dev/null || true

          # 构建 DEB 包
          dpkg-deb --build /tmp/kodi-pkg kodi-21.3-gbm_amd64.deb

          # 验证 DEB 包
          echo "=== 验证 DEB 包 ==="
          dpkg -c kodi-21.3-gbm_amd64.deb | head -10

          # 复制到 artifacts
          mkdir -p ~/artifacts
          cp kodi-21.3-gbm_amd64.deb ~/artifacts/

          echo "=== 生成的 DEB 包 ==="
          ls -lh ~/artifacts/

      # ----------------- 调试步骤 -----------------
      - name: Debug - Check build directory
        run: |
          echo "=== 检查 build 目录 ==="
          find kodi-src/build -name "*.deb" -type f 2>/dev/null || echo "build 目录中没有 DEB 文件"
          echo "=== 检查整个工作空间 ==="
          find . -name "*.deb" -type f | head -20 || echo "工作空间中没有任何 DEB 文件"
          echo "=== 检查 artifacts 目录 ==="
          ls -la ~/artifacts/ || echo "artifacts 目录不存在"
          echo "=== 检查临时安装目录 ==="
          ls -la /tmp/kodi-install/ 2>/dev/null | head -10 || echo "临时安装目录不存在"

      - name: Debug - Check if Kodi binary was built
        run: |
          echo "=== 检查是否编译出 Kodi 可执行文件 ==="
          find kodi-src/build -name "kodi" -type f -executable 2>/dev/null || echo "未找到 kodi 可执行文件"
          find kodi-src/build -name "kodi.bin" -type f -executable 2>/dev/null || echo "未找到 kodi.bin 可执行文件"
          echo "=== 检查 build 目录结构 ==="
          ls -la kodi-src/build/ 2>/dev/null | head -15 || echo "build 目录不存在"

      - name: Create test artifact to verify upload
        run: |
          mkdir -p ~/artifacts
          echo "Kodi build completed at $(date)" > ~/artifacts/build-info.txt
          echo "如果能看到这个文件，说明 artifact 上传功能正常" >> ~/artifacts/build-info.txt

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-files
          path: |
            ~/artifacts/
            kodi-src/build/CMakeCache.txt
          if-no-files-found: warn

      - name: Upload DEB packages (if any)
        uses: actions/upload-artifact@v4
        with:
          name: kodi-deb-packages
          path: ~/artifacts/*.deb
          if-no-files-found: ignore
