name: Build Kodi GBM + PVR IPTV Simple for Ubuntu 24.04

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------- Kodi 源码缓存 -----------------
      - name: Cache Kodi source
        id: cache-kodi
        uses: actions/cache@v4
        with:
          path: kodi-src
          key: kodi-src-21.3-Omega-20251129-gtest-fix
          restore-keys: kodi-src-21.3-Omega-

      - name: Clone Kodi source
        if: steps.cache-kodi.outputs.cache-hit != 'true'
        run: git clone --depth=1 --branch=21.3-Omega https://github.com/xbmc/xbmc.git kodi-src

      # ----------------- 启用 universe + 安装 PCRE3 和 TinyXML -----------------
      - name: Enable universe and install key deps (PCRE3 + TinyXML)
        run: |
          sudo add-apt-repository universe -y
          sudo apt update
          sudo apt install -y libpcre3 libpcre3-dev libtinyxml-dev

      # ----------------- 安装其他依赖（包括 libgtest-dev 源码） -----------------
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            autoconf automake autopoint bison flex gettext libtool libtool-bin \
            cmake curl gcc g++ git pkg-config yasm nasm meson ninja-build swig unzip ccache build-essential \
            libasound2-dev libass-dev libbluray-dev libbz2-dev libcdio-dev libcec-dev \
            libcurl4-openssl-dev libdbus-1-dev libexiv2-dev libflac-dev libfontconfig-dev \
            libfreetype6-dev libfribidi-dev libgcrypt20-dev libgif-dev libgl1-mesa-dev \
            libglu1-mesa-dev libgnutls28-dev libgpg-error-dev libiso9660-dev libjpeg-dev \
            liblcms2-dev liblirc-dev liblzo2-dev libmicrohttpd-dev libnfs-dev libogg-dev \
            libpcre2-dev libplist-dev libpng-dev libpulse-dev libshairplay-dev \
            libsmbclient-dev libspdlog-dev libsqlite3-dev libssl-dev libtag1-dev \
            libtiff5-dev libtinyxml2-dev libudev-dev libva-dev libvdpau-dev \
            libvorbis-dev libxml2-dev libxslt1-dev libxkbcommon-dev libxrandr-dev \
            zlib1g-dev libwayland-dev libgbm-dev libdrm-dev libinput-dev \
            libdisplay-info-dev liburiparser-dev rapidjson-dev nlohmann-json3-dev \
            flatbuffers-compiler libflatbuffers-dev python3-dev libgtest-dev

      # ----------------- 关键修复：手动编译 GTest 库（Ubuntu 24.04 必备） -----------------
      - name: Compile and install GTest libraries
        run: |
          # 进入源码目录，创建 build 并编译（Stack Overflow / Ask Ubuntu fix）
          sudo mkdir -p /usr/src/gtest/build && cd /usr/src/gtest/build
          sudo cmake .. -DCMAKE_BUILD_TYPE=Release
          sudo make -j$(nproc)
          sudo make install  # 安装到 /usr/local/lib (CMake 会找到)
          # 复制静态库到 /usr/lib（确保 FindGTest 找到）
          sudo cp /usr/local/lib/*.a /usr/lib/
          sudo ldconfig  # 更新库缓存

      # ----------------- ccache -----------------
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: kodi-ccache-20251129-gtest-fix
          max-size: 2G

      # ----------------- 验证 GTest、TinyXML 和 PCRE -----------------
      - name: Verify dependencies
        run: |
          ls /usr/lib/libgtest*  # GTest 库文件
          ls /usr/include/tinyxml.h  # TinyXML 头文件
          pcre-config --version  # PCRE 8.39

      # ----------------- 编译 Kodi GBM（不 mv FindPCRE，使用模块模式） -----------------
      - name: Build Kodi GBM
        run: |
          cd kodi-src
          rm -rf build && mkdir build && cd build

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_OPENGL=OFF \
            -DENABLE_OPENGLES=ON \
            -DENABLE_X11=OFF \
            -DENABLE_WAYLAND=OFF \
            -DENABLE_VAAPI=OFF \
            -DENABLE_VDPAU=OFF \
            -DENABLE_PVR=ON \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_INTERNAL_FSTRCMP=ON \
            -DENABLE_PCRE2=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCPACK_GENERATOR=DEB

          make -j$(nproc)
          cpack -G DEB

      # ----------------- 编译 pvr.iptvsimple -----------------
      - name: Build pvr.iptvsimple
        run: |
          cd kodi-src/addons
          rm -rf pvr.iptvsimple
          git clone --depth=1 --branch=Omega https://github.com/kodi-pvr/pvr.iptvsimple.git
          cd pvr.iptvsimple
          mkdir build && cd build

          cmake .. \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DCMAKE_BUILD_TYPE=Release \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_INSTALL_PREFIX=../../build/install \
            -DCPACK_GENERATOR=DEB

          make -j$(nproc)
          cpack -G DEB

          mkdir -p ~/artifacts
          cp ../../build/*.deb ~/artifacts/ 2>/dev/null || true
          cp *.deb ~/artifacts/

      # ----------------- 上传 -----------------
      - name: Upload DEB packages
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm-pvr-iptvsimple-ubuntu24.04-gtest
          path: ~/artifacts/*.deb

      - name: List packages
        run: |
          echo "构建成功！生成的 DEB 包如下："
          ls -lh ~/artifacts/*.deb
