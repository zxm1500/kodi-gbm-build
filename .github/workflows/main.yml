name: Build Kodi 21.3-Omega GBM + DEB for Ubuntu 24.04

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      # 直接用固定 tag，省去一切缓存和 sha 麻烦
      - name: Clone Kodi 21.3-Omega
        run: |
          git clone --depth 1 --branch 21.3-Omega https://github.com/xbmc/xbmc.git kodi-src

      - name: 安装完整依赖（精简但足够）
        run: |
          sudo apt update -qq
          sudo apt install -y \
            build-essential cmake git ccache pkg-config \
            libgbm-dev libdrm-dev libegl1-mesa-dev libgles2-mesa-dev \
            libinput-dev libxkbcommon-dev libudev-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
            libcurl4-openssl-dev libass-dev libfreetype6-dev \
            libfontconfig1-dev libfribidi-dev libtinyxml2-dev \
            rapidjson-dev flatbuffers-compiler libflatbuffers-dev \
            libcrossguid-dev libp8-platform-dev libfmt-dev \
            python3-dev libbluray-dev libnfs-dev libmicrohttpd-dev \
            libsqlite3-dev libtag1-dev libxslt1-dev liblzo2-dev \
            libva-dev libvdpau-dev libcec-dev libplist-dev \
            libshairplay-dev libsmbclient-dev

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: kodi-gbm-21.3-omega-ubuntu24

      - name: 编译 Kodi GBM（官方推荐参数）
        run: |
          cd kodi-src
          mkdir -p build && cd build

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_PVR=ON \
            -DENABLE_EVENTCLIENTS=OFF \
            -DENABLE_INTERNAL_CROSSGUID=ON \
            -DENABLE_INTERNAL_FMT=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

          make -j$(nproc)

      - name: 直接用 checkinstall 打 DEB（最稳最简单）
        run: |
          cd kodi-src/build
          sudo make install DESTDIR=/tmp/inst

          # checkinstall 是最靠谱的打 Kodi deb 方式（自动处理依赖
          sudo apt install -y checkinstall
          cd /tmp/inst

          sudo checkinstall -D --install=no --fstrans=yes \
            --pakdir ~/artifacts \
            --maintainer "GitHub Actions" \
            --pkgname kodi-gbm-omega \
            --pkgversion 21.3 \
            --pkgrelease 1ubuntu24.04 \
            --pkgarch amd64 \
            --nodoc \
            --deldoc=yes \
            --deldesc=yes \
            --delspec=yes \
            --backup=no \
            make install

          # 改个好听的名字
          mv ~/artifacts/kodi-gbm-omega_21.3-1ubuntu24.04_amd64.deb \
             ~/artifacts/kodi-21.3-Omega-gbm_ubuntu24.04_amd64.deb

      - name: 上传最终 DEB 包
        uses: actions/upload-artifact@v4
        with:
          name: kodi-21.3-Omega-gbm-ubuntu24.04
          path: ~/artifacts/*.deb
          if-no-files-found: error

      - name: 完成提示
        run: |
          echo "Kodi 21.3-Omega GBM DEB 构建成功！"
          ls -lh ~/artifacts/
