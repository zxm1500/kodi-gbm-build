name: Build Kodi GBM for Ubuntu 24.04

on:
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # 1️⃣ Checkout 源码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 安装依赖
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git build-essential cmake autopoint gettext \
            libtool curl zip unzip libdrm-dev libgbm-dev libfmt-dev \
            libspdlog-dev libfreetype6-dev libfribidi-dev libpcre3-dev \
            libcrossguid-dev libjpeg-dev libpng-dev libtiff-dev \
            libxml2-dev liblzo2-dev libass-dev libssl-dev libmicrohttpd-dev \
            libbluray-dev libdvdnav-dev libdvdread-dev libcurl4-openssl-dev \
            libcdio-dev libsamplerate0-dev libpulse-dev libinput-dev \
            libudev-dev libxrandr-dev libegl1-mesa-dev libgles2-mesa-dev \
            mesa-utils python3-dev python3-pil python3-setuptools \
            libexiv2-dev ffmpeg libavcodec-dev \
            libavformat-dev libavutil-dev libswscale-dev libtool libdav1d-dev

      # 3️⃣ 下载 Kodi 源码
      - name: Download Kodi source
        run: |
          git clone --depth=1 https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src

      # 4️⃣ 创建 build 目录
      - name: Create build directory
        run: |
          cd kodi-src
          mkdir -p build

      # 5️⃣ 编译 Kodi GBM
      - name: Build Kodi GBM
        run: |
          cd kodi-src/build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_INTERNAL_FSTRCMP=ON
          make -j$(nproc)

      # 6️⃣ 打包为 .deb 文件
      - name: Package Kodi as .deb
        run: |
          cd kodi-src/build
          cpack -G DEB

      # 7️⃣ 上传产物
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm
          path: kodi-src/build/*.deb
