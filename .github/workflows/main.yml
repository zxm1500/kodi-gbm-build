name: Build Kodi GBM (Ubuntu 24.04 x86_64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout build scripts
        uses: actions/checkout@v4

      - name: Clone Kodi source
        run: |
          git clone --depth=1 https://github.com/xbmc/xbmc.git kodi-src

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake autopoint autotools-dev gettext \
            cmake curl default-jre gawk gperf build-essential \
            meson nasm ninja-build uuid-dev ccache unzip zip \
            libasound2-dev libass-dev libavahi-client-dev libavahi-common-dev \
            libbluetooth-dev libbluray-dev libbz2-dev libcdio-dev \
            libcec-dev libp8-platform-dev libcrossguid-dev \
            libcurl4-openssl-dev libcwiid-dev libdbus-1-dev \
            libegl1-mesa-dev libenca-dev libexiv2-dev libflac-dev \
            libfontconfig-dev libfmt-dev libfreetype6-dev libfribidi-dev \
            libfstrcmp-dev libgcrypt-dev libgif-dev libglew-dev \
            libgl1-mesa-dev libglu1-mesa-dev libgnutls28-dev \
            libgpg-error-dev libgtest-dev libiso9660-dev libjpeg-dev \
            liblcms2-dev liblirc-dev libltdl-dev liblzo2-dev \
            libmicrohttpd-dev libmysqlclient-dev libnfs-dev libogg-dev \
            libpcre2-dev libplist-dev libpng-dev libpulse-dev \
            libshairplay-dev libsmbclient-dev libspdlog-dev libsqlite3-dev \
            libssl-dev libtag1-dev libtiff5-dev libtinyxml2-dev \
            libtool libudev-dev libunistring-dev libva-dev libvdpau-dev \
            libvorbis-dev libxkbcommon-dev libxmu-dev libxrandr-dev \
            libxslt1-dev libxt-dev waylandpp-dev wayland-protocols \
            python3 python3-dev python3-pil python3-minimal \
            python3-setuptools python3-wheel python3-venv \
            swig lsb-release

      - name: Prepare build directory
        run: |
          mkdir -p kodi-src/build
          cd kodi-src/build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON
            -DENABLE_CCACHE=ON

      - name: Build Kodi
        run: |
          cd kodi-src/build
          make -j$(nproc)

      - name: Package binaries
        run: |
          mkdir -p artifact
          tar -czf artifact/kodi-gbm.tar.gz -C kodi-src/build kodi.bin
          echo "âœ… Build completed successfully"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm
          path: artifact/kodi-gbm.tar.gz
