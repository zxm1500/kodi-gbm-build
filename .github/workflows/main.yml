name: Build Kodi GBM + PVR IPTV Simple for Ubuntu 24.04

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      # 让所有步骤都能继承这两个路径
      PKG_CONFIG_PATH: /home/runner/.local/lib/pkgconfig
      LD_LIBRARY_PATH: /home/runner/.local/lib

    steps:
      # ----------------- 1. Checkout -----------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------- 2. Cache Kodi source -----------------
      - name: Cache Kodi source
        id: cache-kodi-src
        uses: actions/cache@v4
        with:
          path: kodi-src
          key: kodi-src-21.3-Omega-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: kodi-src-

      - name: Clone Kodi source (if cache miss)
        if: steps.cache-kodi-src.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=21.3-Omega https://github.com/xbmc/xbmc.git kodi-src

      # ----------------- 3. Install system dependencies (完整版) -----------------
      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            autoconf automake autopoint bison flex gettext \
            cmake curl gcc g++ git pkg-config yasm nasm \
            meson ninja-build swig unzip ccache \
            build-essential libtool \
            libasound2-dev libass-dev libavahi-client-dev libavahi-common-dev \
            libbluray-dev libbz2-dev libcdio-dev libcec-dev \
            libcurl4-openssl-dev libdbus-1-dev libexiv2-dev \
            libflac-dev libfontconfig-dev libfreetype6-dev libfribidi-dev \
            libgcrypt20-dev libgif-dev libgl1-mesa-dev libglu1-mesa-dev \
            libgnutls28-dev libgpg-error-dev libiso9660-dev libjpeg-dev \
            liblcms2-dev liblirc-dev liblzo2-dev libmicrohttpd-dev \
            libmysqlclient-dev libnfs-dev libogg-dev libpcre2-dev \
            libplist-dev libpng-dev libpulse-dev libshairplay-dev \
            libsmbclient-dev libspdlog-dev libsqlite3-dev libssl-dev \
            libtag1-dev libtiff5-dev libtinyxml2-dev libudev-dev \
            libva-dev libvdpau-dev libvorbis-dev libxml2-dev libxslt1-dev \
            libxkbcommon-dev libxrandr-dev zlib1g-dev \
            libwayland-dev libwayland-egl-backend-dev wayland-protocols \
            libgbm-dev libdrm-dev libinput-dev libdisplay-info-dev \
            liburiparser-dev rapidjson-dev nlohmann-json3-dev \
            flatbuffers-compiler libflatbuffers-dev \
            python3-dev python3-pip

      # ----------------- 4. Setup ccache -----------------
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: kodi-ccache-ubuntu24-${{ hashFiles('kodi-src/.git/HEAD') }}
          max-size: 2G

      # ----------------- 5. Build & Install Kodi GBM -----------------
      - name: Build Kodi GBM
        run: |
          cd kodi-src
          rm -rf build && mkdir build && cd build

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCORE_PLATFORM_NAME=gbm \
            -DAPP_RENDER_SYSTEM=gles \
            -DENABLE_OPENGL=OFF \
            -DENABLE_OPENGLES=ON \
            -DENABLE_X11=OFF \
            -DENABLE_WAYLAND=OFF \
            -DENABLE_VAAPI=OFF \
            -DENABLE_VDPAU=OFF \
            -DENABLE_PVR=ON \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_DAV1D=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCPACK_GENERATOR=DEB

          make -j$(nproc)
          cpack -G DEB

      # ----------------- 6. Build pvr.iptvsimple (官方推荐方式) -----------------
      - name: Build pvr.iptvsimple add-on
        run: |
          # 直接在 Kodi 源码里建 addon（最稳）
          cd kodi-src
          mkdir -p addons
          cd addons

          # 克最新 Omega 分支
          git clone --depth=1 --branch Omega https://github.com/kodi-pvr/pvr.iptvsimple.git

          mkdir -p pvr.iptvsimple/build && cd pvr.iptvsimple/build

          cmake .. \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DCMAKE_BUILD_TYPE=Release \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_INSTALL_PREFIX=../../build/install \
            -DPACKAGE_ZIP=1 \
            -DCPACK_GENERATOR=DEB

          make -j$(nproc)
          cpack -G DEB

          # 收集生成的 DEB
          mkdir -p ~/artifacts
          cp kodi*.deb ~/artifacts/
          cp pvr.iptvsimple*.deb ~/artifacts/

      # ----------------- 7. Upload all DEB packages -----------------
      - name: Upload DEB Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kodi-gbm-pvr.iptvsimple-ubuntu24.04
          path: ~/artifacts/*.deb
          if-no-files-found: error

      # ----------------- 8. Show generated packages -----------------
      - name: List generated packages
        run: |
          echo "=== 生成的 DEB 包 ==="
          ls -lh ~/artifacts/*.deb
