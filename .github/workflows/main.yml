name: Build Kodi GBM for Ubuntu 24.04

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y autoconf automake autopoint gettext autotools-dev cmake curl default-jre gawk gcc-7 g++-7 cpp-7 flatbuffers gdc gperf libasound2-dev libass-dev libavahi-client-dev libavahi-common-dev libbluetooth-dev libbluray-dev libbz2-dev libcdio-dev libcec4-dev libp8-platform-dev libcrossguid-dev libcurl4-openssl-dev libcwiid-dev libdbus-1-dev libegl1-mesa-dev libenca-dev libexiv2-dev libflac-dev libfontconfig-dev libfmt3-dev libfreetype6-dev libfribidi-dev libfstrcmp-dev libgcrypt-dev libgif-dev libgles2-mesa-dev [armel] libglew-dev libglu1-mesa-dev libgnutls-dev libgpg-error-dev libgtest-dev libiso9660-dev libjpeg-dev liblcms2-dev liblirc-dev libltdl-dev liblzo2-dev libmicrohttpd-dev libmysqlclient-dev libnfs-dev libogg-dev libomxil-bellagio-dev [armel] libpcre2-dev libplist-dev libpng12-dev libpulse-dev libshairplay-dev libsmbclient-dev libspdlog-dev libsqlite3-dev libssl-dev libtag1-dev libtiff5-dev libtinyxml-dev libtinyxml2-dev libtool libudev-dev libunistring-dev libva-dev libvdpau-dev libvorbis-dev libxkbcommon-dev libxmu-dev libxrandr-dev libxslt1-dev libxt-dev waylandpp-dev wayland-protocols lsb-release meson nasm ninja-build python3-dev python3-pil python-support nlohmann-json3-dev python3-minimal swig unzip uuid-dev zip zlib1g-dev

    - name: Clone Kodi
      run: |
        git clone --branch master https://github.com/xbmc/xbmc.git
        cd xbmc
        git submodule update --init --recursive

    - name: Build Kodi GBM
      run: |
        cd xbmc
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCORE_PLATFORM_NAME=gbm -DAPP_RENDER_SYSTEM=gles \
                 -DENABLE_INTERNAL_FFMPEG=ON
        make -j$(nproc)

    - name: Package .deb
      run: |
        cd xbmc/build
        cpack -G DEB
        mkdir -p ../../artifacts
        mv *.deb ../../artifacts/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: kodi-gbm
        path: artifacts/*.deb
